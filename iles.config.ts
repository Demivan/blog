import { defineConfig } from 'iles'

import Unocss from 'unocss/vite'
import { presetWind, presetWebFonts, presetIcons } from 'unocss'

import { BUNDLED_LANGUAGES, getHighlighter } from 'shiki'

import FluentGrammar from './fluent.tmLanguage.json'

function visit(node: any, type: string, fn: (node: any) => void) {
  if (node.type === type)
    fn(node)

  if (node.children)
    node.children.forEach(child => visit(child, type, fn))
}

export default defineConfig(async() => {
  const highlighter = await getHighlighter({
    themes: [
      'material-palenight',
    ],
    langs: [
      ...BUNDLED_LANGUAGES, {
        id: 'ftl',
        scopeName: 'source.ftl',
        grammar: FluentGrammar,
      },
    ],
  })

  return {
    siteUrl: 'https://demivan.me',
    modules: [
      '@islands/feed',
      '@islands/headings',
    ],
    markdown: {
      remarkPlugins: [
        () => {
          function transformer(tree) {
            visit(tree, 'code', visitor)

            function visitor(node) {
              const highlighted = highlighter.codeToHtml(node.value, {
                lang: node.lang,
                theme: 'material-palenight',
              })

              node.type = 'html'
              node.value = highlighted
            }
          }

          return transformer
        },
      ],
    },
    vite: {
      plugins: [
        Unocss({
          safelist: 'prose prose-sm m-auto sr-only'.split(' '),
          presets: [
            presetWind(),
            presetWebFonts({
              provider: 'none',
              fonts: {
                sans: '"Inter", Inter var,system-ui,-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Helvetica Neue,Arial,Noto Sans,sans-serif,Apple Color Emoji,Segoe UI Emoji,Segoe UI Symbol,Noto Color Emoji',
                mono: 'Fira Code'
              },
            }),
            presetIcons({
              collections: {
                logos: {
                  'fluent-vue': '<svg xmlns="http://www.w3.org/2000/svg" width="522" height="453" viewBox="0 0 522 453"><path fill="#41B883" d="M517 5H414.6L209.8 359.4 261 448 517 5" /><path fill="#34495E" d="m5 5 204.8 354.4 51.2-88.6-34.083-58.979h34.095l51.235-88.661H175.682l-17.047-29.499h170.659L380.529 5H5" /></svg>',
                  'fluent': '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 392.087 106.397"><path d="m11.228 73.438 6.299-12.012a16.154 16.154 0 0 1-.655-1.829q-.275-.959-.37-1.827a8.168 8.168 0 0 1-.049-.885 12.287 12.287 0 0 1 .641-3.879 13.768 13.768 0 0 1 .042-.125 15.14 15.14 0 0 1 1.904-3.76q1.618-2.412 3.45-3.422a5.622 5.622 0 0 1 2.752-.728 6.063 6.063 0 0 1 .979.082 7.052 7.052 0 0 1 .339.064 9687.253 9687.253 0 0 1 4.415-7.474q7.135-12.068 9.475-15.919a106.304 106.304 0 0 1 .807-1.314l2.686-4.199Q51.462 5.127 58.201 2.93a15.328 15.328 0 0 1 4.687-.733 5.632 5.632 0 0 1 1.993.341 5.026 5.026 0 0 1 1.938 1.32q1.103 1.19 1.415 3.384a13.454 13.454 0 0 1 .123 1.889q0 9.653-10.117 22.007a87.952 87.952 0 0 1-1.407 1.675L44.138 46.875q-3.369 3.662-6.445 7.52 1.385 1.594 2.589 2.81a39.978 39.978 0 0 0 .389.388q1.367 1.343 2.271 1.343a3.921 3.921 0 0 0 .576-.049q.822-.123 2.085-.562a37.095 37.095 0 0 0 1.39-.516q1.219-.479 2.638-1.119a88.57 88.57 0 0 0 2.35-1.105 112.107 112.107 0 0 0 2.509-1.264 122.181 122.181 0 0 0 5.029-2.758q4.345-2.528 6.709-4.322a22.36 22.36 0 0 0 1.006-.805 29.886 29.886 0 0 1 .178-.15 38.923 38.923 0 0 1 1.921-6.914q2.029-5.559 5.679-11.468a99.115 99.115 0 0 1 7.163-10.033q9.654-12.019 18.211-16.404a29.129 29.129 0 0 1 .197-.1 22.231 22.231 0 0 1 1.265-.598Q103.629 0 104.709 0a7.797 7.797 0 0 1 1.625.164 6.58 6.58 0 0 1 1.012.3 8.262 8.262 0 0 1 2.222 1.294 7.21 7.21 0 0 1 1.504 1.691 5.8 5.8 0 0 1 .888 3.143q0 2.832-1.562 6.714a37.181 37.181 0 0 1-1.846 3.881q-1.159 2.129-2.695 4.395a70.859 70.859 0 0 1-7.947 9.689 95.899 95.899 0 0 1-9.094 8.182 23.603 23.603 0 0 0-2.231 6.566q-.535 2.81-.552 6.02a39.88 39.88 0 0 0 0 .207 10.441 10.441 0 0 0 1.645 5.597 13.066 13.066 0 0 0 .503.751 10.14 10.14 0 0 0 1.271 1.44q1.668 1.538 3.563 1.538a6.532 6.532 0 0 0 2.016-.396q3.228-1.084 9.066-5.123a126.812 126.812 0 0 0 2.736-1.951l8.692-6.69a26.843 26.843 0 0 1 2.52-1.802 42.512 42.512 0 0 1 2.704-3.911 31.054 31.054 0 0 1 5.469-5.468 26.248 26.248 0 0 1 9.976-3.804 25.304 25.304 0 0 1 3.891-.298 8.12 8.12 0 0 1 1.708.167q1.91.412 2.882 1.835.48.698.531 1.768a5.442 5.442 0 0 1 .006.258q0 .968-.428 2.172a11.384 11.384 0 0 1-.28.709q-.708 1.636-1.733 3.418a72.94 72.94 0 0 1-1.588 2.625 84.82 84.82 0 0 1-.683 1.062q-1.245 1.904-2.27 3.711-2.442 4.296-2.442 6.176t1.075 2.759a3.866 3.866 0 0 0 2.045.846 5.09 5.09 0 0 0 .591.033 11.885 11.885 0 0 0 2.908-.34 9.18 9.18 0 0 0 3.001-1.345 43.186 43.186 0 0 0 3.634-2.815 49.592 49.592 0 0 0 1.2-1.066l4.589-4.493 4.444-4.589a78.39 78.39 0 0 1 2.161-2.128q3.082-2.911 4.933-3.849a6.872 6.872 0 0 1 .108-.054 16.135 16.135 0 0 1 .936-.42q1.755-.717 2.653-.483a7.059 7.059 0 0 1 1.279.476 9.362 9.362 0 0 1 1.016.574 14.728 14.728 0 0 1 1.588 1.19 17.379 17.379 0 0 1 .707.641q2.636 2.539 2.929 4.59a8.242 8.242 0 0 1 .019.371q.036 1.241-.217 3.379a52.666 52.666 0 0 1-.021.18q-.275 2.261-.312 3.297a8.264 8.264 0 0 0-.006.292 8.146 8.146 0 0 0 .194 1.861q.723 3.071 4.152 3.071a7.797 7.797 0 0 0 2.477-.49q3.707-1.274 9.935-5.864a118.828 118.828 0 0 0 2.627-1.996l1.564-1.279a32.015 32.015 0 0 1 1.371-1.439 46.196 46.196 0 0 1 3.12-2.848 66.786 66.786 0 0 1 17.236-10.343 78.903 78.903 0 0 1 5.078-1.913q5.409-1.826 9.672-2.387a27.333 27.333 0 0 1 3.561-.25q4.394 0 7.421 2.149a7.953 7.953 0 0 1 2.203 2.359q.956 1.608 1.016 3.663a9.504 9.504 0 0 1 .004.277 9.757 9.757 0 0 1-1.16 4.419q-2.214 4.367-8.654 9.301a52.541 52.541 0 0 1-1.311.994q-.606.443-1.159.816a29.418 29.418 0 0 1-.362.241l-1.758 1.172q-4.883 3.418-14.844 7.666 2.608 1.366 4.917 1.574a9.139 9.139 0 0 0 .82.037q2.662 0 4.786-.634 1.825-.546 4.065-1.488a60.831 60.831 0 0 0 .744-.319 71.369 71.369 0 0 0 3.137-1.465 91.592 91.592 0 0 0 2.6-1.343 106.134 106.134 0 0 0 5.397-3.105 116.548 116.548 0 0 0 .78-.484 103.064 103.064 0 0 0 6.519-4.394 78.264 78.264 0 0 0 5.205-4.155 45.803 45.803 0 0 1 1.264-2.339q4.297-7.471 10.547-10.352a15.676 15.676 0 0 1 6.836-1.514 15.248 15.248 0 0 1 2.274.155q2.937.445 3.92 2.174a4.11 4.11 0 0 1 .496 2.066q0 2.491-2.731 7.922a71.087 71.087 0 0 1-.443.867l-1.465 2.881a84.959 84.959 0 0 0-.355.684q-1.16 2.261-1.16 2.659a.211.211 0 0 0 .001.026 3.328 3.328 0 0 0 .163.57q.114.286.273.481a1.086 1.086 0 0 0 .883.414 2.277 2.277 0 0 0 .672-.117q.99-.31 2.511-1.441a21.71 21.71 0 0 0 .137-.102l8.984-6.69 4.493-3.125q7.37-4.82 11.044-5.065a5.755 5.755 0 0 1 .381-.013 4.753 4.753 0 0 1 2.844.954 6.588 6.588 0 0 1 .721.609 17.35 17.35 0 0 1 1.285 1.349q1.693 1.999 1.693 3.582a9.657 9.657 0 0 1-.017.554q-.014.248-.04.525a19.671 19.671 0 0 1-.065.581 357.255 357.255 0 0 1-.128 1.014 440.952 440.952 0 0 1-.14 1.086l-.196 2.295a18.824 18.824 0 0 0-.136 1.669 16.341 16.341 0 0 0-.01.577 11.403 11.403 0 0 0 .091 1.51q.221 1.644.979 2.367a2.11 2.11 0 0 0 1.518.566 12.897 12.897 0 0 0 4.221-.797q3.793-1.323 8.558-4.839a71.663 71.663 0 0 0 3.725-2.957l1.318-1.123a26.146 26.146 0 0 1 .038-.026 106.31 106.31 0 0 1 1.738-4.59q1.302-3.195 2.701-5.922a59.08 59.08 0 0 1 .943-1.767 24.639 24.639 0 0 0 .299-.581q.58-1.171.58-1.567h-6.299a12.295 12.295 0 0 1-2.154-.177q-2.047-.365-3.363-1.484a6.561 6.561 0 0 1-1.092-1.165 4.363 4.363 0 0 1-.862-2.594 8.963 8.963 0 0 1 .062-1.093q.142-1.151.609-1.834a2.474 2.474 0 0 1 .111-.15q.781-.976 1.953-1.416a7.147 7.147 0 0 1 1.19-.36q1.269-.278 3.084-.317a28.299 28.299 0 0 1 .609-.006l11.962.049a.632.632 0 0 0 .191-.134q.406-.38 1.238-1.744a37.051 37.051 0 0 0 .134-.222l2.978-5.127q1.265-2.27 2.54-3.743a11.358 11.358 0 0 1 1.293-1.286 6.862 6.862 0 0 1 4.541-1.612q2.001 0 3.514.287a11.242 11.242 0 0 1 .881.202 15.018 15.018 0 0 1 1.44.469q.708.274 1.297.599a8.468 8.468 0 0 1 .266.152 8.173 8.173 0 0 1 1.075.826q.525.484.841.994a2.994 2.994 0 0 1 .477 1.598 3.128 3.128 0 0 1-.053.541q-.099.561-.385 1.308a12.791 12.791 0 0 1-.1.251l-2.734 6.641 23.193-.049a4.207 4.207 0 0 1 1.217.16q1.811.548 1.811 2.965a6.113 6.113 0 0 1-3.845 5.845q-2.797 1.341-7.628 1.542a42.492 42.492 0 0 1-1.76.035l-17.871.049a1.162 1.162 0 0 0-.284.223q-.59.595-1.681 2.542a45.045 45.045 0 0 0-.037.067l-2.197 4.052a64.38 64.38 0 0 0-.385.711q-.529.995-.785 1.581a9.396 9.396 0 0 0-.002.003l-1.074 2.393a77.254 77.254 0 0 0-1.393 3.331q-1.879 4.834-1.879 7.313a10.205 10.205 0 0 0 .309 2.569 7.778 7.778 0 0 0 1.425 2.9 5.509 5.509 0 0 0 3.998 2.171 7.093 7.093 0 0 0 .616.026 14.833 14.833 0 0 0 5.64-1.123q2.759-1.123 5.395-2.734a74.218 74.218 0 0 0 3.048-1.996q2.677-1.855 4.472-3.522 2.609-2.423 4.374-3.734a23.814 23.814 0 0 1 .167-.123l3.418-2.393a18.925 18.925 0 0 1 1.248-.769q1.251-.7 2.185-.904a3.368 3.368 0 0 1 .717-.084 10.21 10.21 0 0 1 1.687.126q2.993.504 3.095 3.014a4.424 4.424 0 0 1 .003.18 6.163 6.163 0 0 1-.417 2.106q-.691 1.889-2.529 4.252a35.562 35.562 0 0 1-1.546 1.845l-2.392 2.49a78.038 78.038 0 0 1-5.832 5.361 97.522 97.522 0 0 1-4.3 3.379 140.24 140.24 0 0 1-4.144 2.969q-3.29 2.262-6.037 3.819-7.484 4.154-13.944 5.261a26.982 26.982 0 0 1-4.562.403 21.24 21.24 0 0 1-5.872-.774 16.373 16.373 0 0 1-6.872-3.914q-3.266-3.116-4.021-6.492a9.379 9.379 0 0 1-.227-2.053 45.942 45.942 0 0 1 .061-2.368 70.298 70.298 0 0 1-2.096 1.457 87.532 87.532 0 0 1-2.457 1.595 59.541 59.541 0 0 1-6.673 3.656q-3.658 1.69-7.027 2.508a25.728 25.728 0 0 1-6.076.769 8.147 8.147 0 0 1-3.297-.63q-3.273-1.434-4.362-6.13a16.324 16.324 0 0 1-.007-.027 29.089 29.089 0 0 1-.488-2.347 24.666 24.666 0 0 1-.146-1.022 50.102 50.102 0 0 0-.185-1.34q-.374-2.451-.776-2.94a.473.473 0 0 0-.065-.066q-.537-.439-2.124.074a15.177 15.177 0 0 0-1.265.477q-.637.271-1.347.627a33.719 33.719 0 0 0-1.148.605 65.331 65.331 0 0 0-2.139 1.234q-1.269.763-2.67 1.671-11.887 7.897-15.177 10.027a81.315 81.315 0 0 1-.888.569 60.714 60.714 0 0 1-1.771 1.062q-3.587 2.063-5.016 2.063a8.555 8.555 0 0 1-3.442-.733 11.438 11.438 0 0 1-2.293-1.318 10.272 10.272 0 0 1-.661-.537 11.098 11.098 0 0 1-1.362-1.527q-.677-.931-.995-1.875a5.231 5.231 0 0 1-.28-1.676 57.375 57.375 0 0 1 .276-6.002 101.232 101.232 0 0 1-4.881 3.199 122.789 122.789 0 0 1-3.403 2.021q-4.687 2.686-9.961 4.834a66.174 66.174 0 0 1-12.192 3.734 53.315 53.315 0 0 1-10.415 1.052 27.086 27.086 0 0 1-8.279-1.227 23.557 23.557 0 0 1-6.321-3.119 18.702 18.702 0 0 1-3.45-3.029 11.847 11.847 0 0 1-2.487-4.242 122.546 122.546 0 0 1-.166.117 86.05 86.05 0 0 1-6.787 4.322q-6.866 3.998-11.567 4.438a12.12 12.12 0 0 1-1.129.054 13.572 13.572 0 0 1-4.103-.591 10.711 10.711 0 0 1-5.223-3.608q-2.895-3.563-3.474-9.32a27.862 27.862 0 0 1-.09-1.129q-8.789 9.033-18.604 13.916a39.358 39.358 0 0 1-3.572 1.57q-3.731 1.408-6.584 1.408a29.274 29.274 0 0 1-3.435-.192q-1.822-.215-3.396-.673a17.384 17.384 0 0 1-.444-.136 15.945 15.945 0 0 1-4.563-2.287 14.942 14.942 0 0 1-.906-.716 13.867 13.867 0 0 1-4.9-9.095 20.033 20.033 0 0 1-.065-.537 130.589 130.589 0 0 1-3.336 2.796 74.343 74.343 0 0 1-7.592 5.382q-8.898 5.444-16.416 5.735a21.844 21.844 0 0 1-.845.016q-7.862 0-12.891-6.836a25.122 25.122 0 0 1-3.877-8.2 37.593 37.593 0 0 1-.664-2.901 61.965 61.965 0 0 1-1.267 1.091 76.945 76.945 0 0 1-3.128 2.491 65.295 65.295 0 0 1-8.862 5.639 58.118 58.118 0 0 1-9.473 4.004 34.218 34.218 0 0 1-4.657 1.154 25.855 25.855 0 0 1-4.351.384 11.284 11.284 0 0 1-3.517-.604q-1.522-.5-3.161-1.411a28.261 28.261 0 0 1-2.795-1.793 317.619 317.619 0 0 0-1.44 8.471 103.663 103.663 0 0 1-1.249 6.622 92.701 92.701 0 0 1-.338 1.459 48.924 48.924 0 0 1-1.574 5.268 42.367 42.367 0 0 1-.746 1.91 19.848 19.848 0 0 1-2.286 4.085 17.465 17.465 0 0 1-1.351 1.628 16.181 16.181 0 0 1-8.545 4.702 24.24 24.24 0 0 1-5.176.523 2.963 2.963 0 0 1-1.245-.257 2.903 2.903 0 0 1-1.001-.769q-1.563-1.855-1.27-4.223a16.174 16.174 0 0 1 .266-1.493q.357-1.617 1.099-3.847a73.883 73.883 0 0 1 .491-1.423 107.958 107.958 0 0 1 1.739-4.545q.938-2.304 2.065-4.812a174.076 174.076 0 0 1 .151-.336 293.758 293.758 0 0 1 3.219-6.879 359.728 359.728 0 0 1 2.152-4.375Zm202.93-17.969 2.685-1.367a78.936 78.936 0 0 0 1.172-.62q.549-.296 1.034-.572a47.236 47.236 0 0 0 .138-.078 436.944 436.944 0 0 0 3.4-1.971q6.72-3.94 7.83-5.011a15.397 15.397 0 0 0 .465-.466q.688-.723.851-1.137a.633.633 0 0 0 .052-.228q0-.396-.175-.894a4.826 4.826 0 0 0-.118-.303 4.344 4.344 0 0 0-.782-1.22 5.148 5.148 0 0 0-.708-.692q-.855-.676-1.782-.676a8.367 8.367 0 0 0-1.385.123q-.727.122-1.52.366a17.72 17.72 0 0 0-2.394.938 20.498 20.498 0 0 0-.804.405 19.648 19.648 0 0 0-3.101 2.05q-1.489 1.197-2.612 2.564a17.688 17.688 0 0 0-1.193 1.575q-1.123 1.688-1.342 3.086a4.264 4.264 0 0 0-.053.661q0 2.246.342 3.467Z" /></svg>'
                }
              }
            }),
          ]
        })
      ],
    },
  }
})
